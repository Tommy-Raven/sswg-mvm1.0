name: SSWGâ€“MVM API CI

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# EVENT TRIGGERS
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
on:
  push:
    branches: ["main", "dev"]
    paths:
      - "API/**"
      - "generator/**"
      - "ai_core/**"
      - "ai_validation/**"
      - "ai_recursive/**"
      - "ai_graph/**"
      - "ai_memory/**"
      - "ai_monitoring/**"
      - "ai_visualization/**"
      - ".github/workflows/sswg-api.yml"
  pull_request:
    branches: ["main", "dev"]
    paths:
      - "API/**"
      - "generator/**"
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  pull-requests: write

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# JOB 1 â€” BUILD API
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
jobs:
  build_api:
    name: ğŸ§© Build API (FastAPI)
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§¾ Checkout
        uses: actions/checkout@v4

      - name: ğŸ Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ğŸ“¦ Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          # Primary dependency path
          if [ -f reproducibility/requirements.txt ]; then
            pip install -r reproducibility/requirements.txt
          elif [ -f REQUIREMENTS.txt ]; then
            pip install -r REQUIREMENTS.txt
          fi
          pip install fastapi uvicorn flake8 pytest httpx

      - name: ğŸ” Lint API + Core
        run: |
          echo "Running flake8..."
          flake8 API generator ai_core --max-line-length=120 --statistics

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 2 â€” API TEST SUITE
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  test_api:
    name: ğŸ§ª API Tests (FastAPI)
    needs: build_api
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ğŸ“¦ Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          if [ -f reproducibility/requirements.txt ]; then
            pip install -r reproducibility/requirements.txt
          elif [ -f REQUIREMENTS.txt ]; then
            pip install -r REQUIREMENTS.txt
          fi
          pip install fastapi uvicorn pytest httpx

      - name: ğŸ§ª Run API test suite
        run: |
          pytest -q API/tests --disable-warnings --maxfail=1

      - name: ğŸ“Š Upload API Test Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fastapi-test-results
          path: ./API/tests/

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 3 â€” API ROUTE SMOKE TEST
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  smoke_test:
    name: ğŸš¦ API Smoke Test (Endpoint Health)
    needs: test_api
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ğŸ“¦ Install FastAPI + test deps
        run: |
          python3 -m pip install --upgrade pip
          pip install fastapi uvicorn httpx

      - name: â–¶ï¸ Launch API in Background
        run: |
          nohup uvicorn API.workflows:app --host 127.0.0.1 --port 8000 &
          sleep 3

      - name: ğŸ”¥ Test /api/status route
        run: |
          python3 - <<'EOF'
          import httpx
          r = httpx.get("http://127.0.0.1:8000/api/status")
          print("Status Code:", r.status_code)
          print("Response:", r.text)
          assert r.status_code == 200
          EOF

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 4 â€” NOTIFY RESULT
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  notify:
    name: ğŸ”” Notify Success
    needs: smoke_test
    runs-on: ubuntu-latest
    if: success()

    steps:
      - name: ğŸ‰ Complete
        run: echo "âœ… API CI Pipeline Completed Successfully."
