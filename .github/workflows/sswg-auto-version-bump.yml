name: SSWG–MVM Auto Version Bump (v0.9.mvm.25)

# ───────────────────────────────────────────────
# TRIGGERS
# ───────────────────────────────────────────────
on:
  push:
    branches: ["main"]
    paths:
      - "generator/**"
      - "ai_core/**"
      - "ai_recursive/**"
      - "ai_validation/**"
      - "ai_graph/**"
      - "ai_monitoring/**"
      - "ai_memory/**"
      - "ai_visualization/**"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

# ───────────────────────────────────────────────
# JOB: VERSION BUMP
# ───────────────────────────────────────────────
jobs:
  bump-version:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:

      # ----------------------------------------------------
      # 1) Checkout repository
      # ----------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 #v6
        with:
          fetch-depth: 0

      # ----------------------------------------------------
      # 2) Detect changed files
      # ----------------------------------------------------
      - name: Get changed files
        id: diff
        run: |
          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          git diff --name-only HEAD~1 HEAD >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # ----------------------------------------------------
      # 3) Determine if changes touch CORE modules
      # ----------------------------------------------------
      - name: Detect core module changes
        id: detect_core
        run: |
          echo "core_changed=false" >> $GITHUB_OUTPUT
          while read -r file; do
            case "$file" in
              generator/*|ai_core/*|ai_recursive/*|ai_validation/*|ai_graph/*|ai_monitoring/*|ai_memory/*|ai_visualization/*)
                echo "Core module touched: $file"
                echo "core_changed=true" >> $GITHUB_OUTPUT
                break
                ;;
            esac
          done <<< "${{ steps.diff.outputs.changed_files }}"

      # ----------------------------------------------------
      # 4) Exit if nothing relevant changed
      # ----------------------------------------------------
      - name: Stop (no version bump needed)
        if: steps.detect_core.outputs.core_changed == 'false'
        run: echo "No core module changes detected — skipping version bump."

      # ----------------------------------------------------
      # 5) Bump semantic version (v.XX.mvm.YY)
      # ----------------------------------------------------
      - name: Bump version
        if: steps.detect_core.outputs.core_changed == 'true'
        id: bump
        run: |
          version_file="pyproject.toml"

          echo "Extracting current version..."
          current=$(grep -E '^version *= *"' "$version_file" | sed -E 's/.*"([^"]+)".*/\1/')

          echo "Current version: $current"

          major=$(echo "$current" | cut -d'.' -f1 | sed 's/v//')
          minor=$(echo "$current" | cut -d'.' -f2)
          patch=$(echo "$current" | cut -d'.' -f4)

          new_patch=$((patch + 1))
          new_version="v.${major}.${minor}.mvm.${new_patch}"

          echo "Bumping to new version: $new_version"

          sed -i "s/version = \".*\"/version = \"${new_version}\"/" "$version_file"
          echo "new_version=${new_version}" >> $GITHUB_OUTPUT

      # ----------------------------------------------------
      # 6) Update CHANGELOG.md
      # ----------------------------------------------------
      - name: Update CHANGELOG
        if: steps.detect_core.outputs.core_changed == 'true'
        run: |
          echo "Updating CHANGELOG.md..."

          ts=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          bump="${{ steps.bump.outputs.new_version }}"

          touch CHANGELOG.md

          {
            echo "## ${bump} — ${ts}"
            echo ""
            echo "**Changed core modules:**"
            echo "${{ steps.diff.outputs.changed_files }}"
            echo ""
          } >> CHANGELOG.md

      # ----------------------------------------------------
      # 7) Commit changes
      # ----------------------------------------------------
      - name: Commit changes
        id: commit_changes
        if: steps.detect_core.outputs.core_changed == 'true'
        run: |
          git config --global user.name "SSWG-MVM AutoBump Bot"
          git config --global user.email "actions@github.com"

          branch="auto-bump-${{ steps.bump.outputs.new_version }}"
          git checkout -b "$branch"

          git add pyproject.toml CHANGELOG.md
          git commit -m "Auto version bump to ${{ steps.bump.outputs.new_version }} (core module changes detected)"
          git push origin "$branch"

          echo "branch_name=${branch}" >> $GITHUB_OUTPUT

      # ----------------------------------------------------
      # 8) Create Pull Request
      # ----------------------------------------------------
    #  - name: Create Pull Request
   #     if: steps.detect_core.outputs.core_changed == 'true'
     #   with:
    #      token: ${{ secrets.GITHUB_TOKEN }}
     #     title: "Version Bump: ${{ steps.bump.outputs.new_version }}"
     #     body: |
       #     This automated PR bumps the SSWG-MVM version to:

     #       **${{ steps.bump.outputs.new_version }}**

            ### Reason
    #        Core module changes were detected in:
      #      ```
    #     #   ${{ steps.diff.outputs.changed_files }}
        #    ```

            ### Generated by
     #       **SSWG–MVM AutoBump Engine v0.9.mvm.25**

    #        Admin approval is required before merge.
    #      base: main
    #      branch: ${{ steps.commit_changes.outputs.branch_name }}

      # ----------------------------------------------------
      # 9) Optional Git Tag Creation
      # ----------------------------------------------------
      - name: Create Git Tag
        if: steps.detect_core.outputs.core_changed == 'true'
        run: |
          git tag "${{ steps.bump.outputs.new_version }}"
          git push origin "${{ steps.bump.outputs.new_version }}"      # ----------------------------------------------------
      - name: Create Git Tag
        if: steps.detect_core.outputs.core_changed == 'true'
        run: |
          git tag "${{ steps.bump.outputs.new_version }}"
          git push origin "${{ steps.bump.outputs.new_version }}"
