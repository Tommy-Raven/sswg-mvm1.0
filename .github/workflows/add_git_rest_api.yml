name: "SSWGâ€“MVM: Generate git_REST_API.md"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# EVENT TRIGGERS
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
on:
  workflow_dispatch:
  push:
    branches: ["main"]
    paths:
      - "scripts/write_git_REST_API_md.py"
      - ".github/workflows/sswg-generate-git-rest-api.yml"
  pull_request:
    types: [opened, reopened, synchronize]
    branches: ["main"]

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# PERMISSIONS
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
permissions:
  contents: write
  pull-requests: write

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# JOB DEFINITION
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
jobs:
  generate-rest-api-doc:
    name: Generate git_REST_API.md (SSWGâ€“MVM)
    runs-on: ubuntu-latest
    timeout-minutes: 8

    steps:
      # ----------------------------------------------------
      # 1. Checkout
      # ----------------------------------------------------
      - name: Checkout Repository
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332
        with:
          fetch-depth: 0   # needed for PR diff, change detection

      # ----------------------------------------------------
      # 2. Setup Python
      # ----------------------------------------------------
      - name: ðŸ“¦ Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          if [ -f reproducibility/requirements.txt ]; 
            then
              pip install -r reproducibility/requirements.txt
          elif [ -f REQUIREMENTS.txt ]; 
            then
              pip install -r REQUIREMENTS.txt
          fi
          pip install fastapi uvicorn flake8 pytest httpx pytest rich black json
          # Optional: install SSWG local project (editable mode)
          if [ -f pyproject.toml ]; then pip install -e .; fi

      # ----------------------------------------------------
      # 3. Run Generator Script
      # ----------------------------------------------------
      - name: Generate git_REST_API.md
        id: generate_doc
        run: |
          echo "[SSWG-MVM] Running documentation generator script..."
          python3 scripts/write_git_REST_API_md.py

      # ----------------------------------------------------
      # 4. Detect Changed Content
      # ----------------------------------------------------
      - name: Detect Changes
        id: detect_changes
        run: |
          if git diff --quiet git_REST_API.md; then
            echo "doc_changed=false" >> $GITHUB_OUTPUT
          else
            echo "doc_changed=true" >> $GITHUB_OUTPUT
          fi

      # ----------------------------------------------------
      # 5. Commit to Auto-Branch When Changes Exist
      # ----------------------------------------------------
      - name: Commit Updated Documentation
        if: steps.detect_changes.outputs.doc_changed == 'true'
        run: |
          git config --global user.name "SSWG-MVM AutoDoc Bot"
          git config --global user.email "actions@github.com"

          branch="autodoc/git-rest-api-$(date +'%Y%m%d-%H%M%S')"
          git checkout -b "$branch"

          git add git_REST_API.md
          git commit -m "Auto-generate git_REST_API.md (SSWG-MVM v0.9.mvm.25)"
          git push origin "$branch"

          echo "branch_name=$branch" >> $GITHUB_OUTPUT

      # ----------------------------------------------------
      # 6. Create PR (SSWG-compliant)
      # ----------------------------------------------------
      - name: Open Pull Request
        if: steps.detect_changes.outputs.doc_changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "SSWG-MVM AutoDoc Update: git_REST_API.md"
          body: |
            Automated documentation refresh generated under:

            - **Engine:** SSWGâ€“MVM v0.9.mvm.25  
            - **Module:** Recursive AutoDoc Processor  
            - **Event:** `${{ github.event_name }}`  
            - **Bot:** SSWG-MVM AutoDoc

            This PR updates:  
            **git_REST_API.md**

            All changes originate from  
            `scripts/write_git_REST_API_md.py`

          branch: ${{ steps.commit_updated_documentation.outputs.branch_name }}
          base: main

      # ----------------------------------------------------
      # 7. Upload Artifacts (Optional but recommended)
      # ----------------------------------------------------
      - name: Upload Documentation Artifact
        if: steps.detect_changes.outputs.doc_changed == 'true'
        uses: actions/upload-artifact@0b2256b8c012f0828dc542b3febcab082c67f72b
        with:
          name: git_REST_API_doc
          path: git_REST_API.md
