name: SSWG–MVM Auto Version Bump

# ───────────────────────────────────────────────
# TRIGGERS
# ───────────────────────────────────────────────
on:
  push:
    branches: ["main"]
    paths:
      - "generator/**"
      - "ai_core/**"
      - "ai_recursive/**"
      - "ai_validation/**"
      - "ai_graph/**"
      - "ai_monitoring/**"
      - "ai_memory/**"
      - "ai_visualization/**"

  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

# ───────────────────────────────────────────────
# JOB: VERSION BUMP
# ───────────────────────────────────────────────
jobs:
  bump-version:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:

      # ----------------------------------------------------
      # 1. Checkout repository
      # ----------------------------------------------------
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # required for diff + tagging

      # ----------------------------------------------------
      # 2. Get list of changed files
      # ----------------------------------------------------
      - name: Get changed files
        id: diff
        run: |
          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          git diff --name-only HEAD~1 HEAD >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # ----------------------------------------------------
      # 3. Determine if changes touch CORE modules
      # ----------------------------------------------------
      - name: Detect core module changes
        id: detect_core
        run: |
          echo "core_changed=false" >> $GITHUB_OUTPUT
          while read -r file; do
            case "$file" in
              generator/*|ai_core/*|ai_recursive/*|ai_validation/*|ai_graph/*|ai_monitoring/*|ai_memory/*|ai_visualization/*)
                echo "Core module touched: $file"
                echo "core_changed=true" >> $GITHUB_OUTPUT
                break
                ;;
            esac
          done <<< "${{ steps.diff.outputs.changed_files }}"

      # ----------------------------------------------------
      # 4. Stop workflow if no core change
      # ----------------------------------------------------
      - name: Stop (no version bump needed)
        if: steps.detect_core.outputs.core_changed == 'false'
        run: echo "No core module changes detected — skipping version bump."

      # ----------------------------------------------------
      # 5. Bump version (MVM-style)
      # ----------------------------------------------------
      - name: Bump version (v.XX.mvm.YYYY)
        if: steps.detect_core.outputs.core_changed == 'true'
        id: bump
        run: |
          echo "Starting auto-version bump..."
          version_file="pyproject.toml"

          # Extract current version
          current=$(grep -E '^version *= *"' $version_file | sed -E 's/version *= *"([^"]+)"/\1/')
          echo "Current version: $current"

          # Parse version (format: v.09.mvm.25)
          major=$(echo $current | cut -d'.' -f1 | sed 's/v//')
          minor=$(echo $current | cut -d'.' -f2)
          patch=$(echo $current | cut -d'.' -f4)

          # Increment patch version
          new_patch=$((patch + 1))

          new_version="v.${major}.${minor}.mvm.${new_patch}"
          echo "Bumping to: $new_version"

          # Rewrite in pyproject.toml
          sed -i "s/version = \".*\"/version = \"${new_version}\"/" $version_file

          echo "new_version=${new_version}" >> $GITHUB_OUTPUT

      # ----------------------------------------------------
      # 6. Append CHANGELOG entry
      # ----------------------------------------------------
      - name: Update CHANGELOG
        if: steps.detect_core.outputs.core_changed == 'true'
        run: |
          echo "Updating CHANGELOG.md"
          ts=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          {
            echo "## ${ { steps.bump.outputs.new_version } } — ${ts}"
            echo ""
            echo "**Changed core modules:**"
            echo "${{ steps.diff.outputs.changed_files }}"
            echo ""
          } >> CHANGELOG.md

      # ----------------------------------------------------
      # 7. Commit bump + changelog
      # ----------------------------------------------------
      - name: Commit changes
        if: steps.detect_core.outputs.core_changed == 'true'
        run: |
          git config --global user.name "SSWG-MVM AutoBump Bot"
          git config --global user.email "actions@github.com"

          branch="auto-bump-${{ steps.bump.outputs.new_version }}"
          git checkout -b "$branch"

          git add pyproject.toml CHANGELOG.md
          git commit -m "Auto version bump to ${{ steps.bump.outputs.new_version }} (core module changes detected)"
          git push origin "$branch"

          echo "branch_name=$branch" >> $GITHUB_OUTPUT

      # ----------------------------------------------------
      # 8. Create Pull Request
      # ----------------------------------------------------
      - name: Create Pull Request
        if: steps.detect_core.outputs.core_changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "Version Bump: ${{ steps.bump.outputs.new_version }}"
          body: |
            This automated PR bumps the SSWG-MVM version to:

            **${{ steps.bump.outputs.new_version }}**

            ### Reason
            Core module changes were detected in:
            ```
            ${{ steps.diff.outputs.changed_files }}
            ```

            ### Generated by
            **SSWG–MVM AutoBump Engine v0.9.mvm.25**

            Admin approval required before merging.
          base: main
          branch: ${{ steps.commit_changes.outputs.branch_name }}

      # ----------------------------------------------------
      # 9. (Optional) Create Git Tag
      # ----------------------------------------------------
      - name: Create Git Tag
        if: steps.detect_core.outputs.core_changed == 'true'
        run: |
          git tag "${{ steps.bump.outputs.new_version }}"
          git push origin "${{ steps.bump.outputs.new_version }}"
