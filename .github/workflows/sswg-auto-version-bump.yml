name: SSWG–MVM Auto Version Bump

on:
  push:
    branches: ["main"]
    paths:
      - "generator/**"
      - "ai_core/**"
      - "ai_recursive/**"
      - "ai_validation/**"
      - "ai_graph/**"
      - "ai_monitoring/**"
      - "ai_memory/**"
      - "ai_visualization/**"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  bump-version:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      # 1) Checkout
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
        with:
          fetch-depth: 0

      # 2) Detect changed files
      - name: Detect changes
        id: diff
        run: |
          git diff --name-only HEAD~1 HEAD > changed_files.txt
          echo "changed=$(cat changed_files.txt | wc -l)" >> $GITHUB_OUTPUT

      # 3) Determine relevance
      - name: Check core module impact
        id: core
        run: |
          core=false
          while read -r file; do
            case "$file" in
              generator/*|ai_core/*|ai_recursive/*|ai_validation/*|ai_graph/*|ai_monitoring/*|ai_memory/*|ai_visualization/*)
                core=true
                break
                ;;
            esac
          done < changed_files.txt
          echo "core_changed=$core" >> $GITHUB_OUTPUT

      # 4) Stop if irrelevant
      - name: Skip if no core change
        if: steps.core.outputs.core_changed == 'false'
        run: echo "No core changes — skipping version bump."

      # 5) Bump version
      - name: Bump version
        if: steps.core.outputs.core_changed == 'true'
        id: bump
        run: |
          version_file="pyproject.toml"
          current=$(grep '^version *= *"' "$version_file" | sed -E 's/.*"([^"]+)".*/\1/')
          major=$(echo "$current" | cut -d'.' -f2)
          minor=$(echo "$current" | cut -d'.' -f3)
          patch=$(echo "$current" | cut -d'.' -f5)

          new_patch=$((patch + 1))
          new_version="v.${major}.${minor}.mvm.${new_patch}"

          sed -i "s/version = \".*\"/version = \"${new_version}\"/" "$version_file"
          echo "new_version=$new_version" >> $GITHUB_OUTPUT

      # 6) Update changelog
      - name: Update CHANGELOG
        if: steps.core.outputs.core_changed == 'true'
        run: |
          ts=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          {
            echo "## ${{ steps.bump.outputs.new_version }} — $ts"
            echo ""
            echo "**Changed files:**"
            cat changed_files.txt
            echo ""
          } >> CHANGELOG.md

      # 7) Commit and push branch
      - name: Commit changes
        if: steps.core.outputs.core_changed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "SSWG AutoBump"
          git config user.email "actions@github.com"

          branch="auto-bump-${{ steps.bump.outputs.new_version }}"
          git checkout -b "$branch"
          git add pyproject.toml CHANGELOG.md
          git commit -m "Auto bump to ${{ steps.bump.outputs.new_version }}"
          git push origin "$branch"

          echo "BRANCH=$branch" >> $GITHUB_ENV

      # 8) Create PR (FIRST-PARTY)
      - name: Open pull request
        if: steps.core.outputs.core_changed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --base main \
            --head "$BRANCH" \
            --title "Version bump: ${{ steps.bump.outputs.new_version }}" \
            --body "Automated version bump due to core module changes."

      # 9) Tag release
      - name: Tag version
        if: steps.core.outputs.core_changed == 'true'
        run: |
          git tag "${{ steps.bump.outputs.new_version }}"
          git push origin "${{ steps.bump.outputs.new_version }}"
