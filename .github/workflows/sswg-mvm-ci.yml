name: SSWG MVM CI & Validation

on:
  push:
    paths:
      - "sswg.yaml"
      - "mvm.yaml"
      - "execution_policy.yaml"
      - "governance.yaml"
      - "invariants.yaml"
      - "root_contract.yaml"
      - "ai_system_prompt.txt"
      - "data/templates/**"
      - "ai_validation/**"
      - "schemas/**"
      - "generator/**"
      - "ai_graph/**"
      - "ai_visualization/**"
      - "tests/**"
      - ".github/workflows/sswg-mvm-ci.yml"
  pull_request:
    paths:
      - "sswg.yaml"
      - "mvm.yaml"
      - "execution_policy.yaml"
      - "governance.yaml"
      - "invariants.yaml"
      - "root_contract.yaml"
      - "ai_system_prompt.txt"
      - "data/templates/**"
      - "ai_validation/**"
      - "schemas/**"
      - "generator/**"
      - "ai_graph/**"
      - "ai_visualization/**"
      - "tests/**"
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.10]

    steps:
      - uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332
      - name: ðŸ“¦ Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          if [ -f reproducibility/requirements.txt ]; 
            then
              pip install -r reproducibility/requirements.txt
          elif [ -f REQUIREMENTS.txt ]; 
            then
              pip install -r REQUIREMENTS.txt
          if [ -f pyproject.toml ]; 
            then
              pip install -e ".[dev]"
          elif [ -f build/REQUIREMENTS.txt ]; 
            then
              pip install -r build/REQUIREMENTS.txt
          pip install fastapi uvicorn flake8 pytest httpx pytest rich black json

      - name: Schema validation (example workflows)
        run: |
          python -c "from ai_validation.schema_validator import validate_workflow; import json; import sys; wf=json.load(open('data/templates/campfire_workflow.json')); ok, errs=validate_workflow(wf); sys.exit(1 if not ok else 0)"

      - name: PDL validation (example phase set)
        run: |
          python -m generator.pdl_validator pdl/example_full_9_phase.yaml schemas --report-dir artifacts/validation --run-id ci-run

      - name: Golden-path end-to-end run
        run: |
          python scripts/run_golden_path.py --out-dir artifacts/golden_path --no-refine --no-history

      - name: Upload golden-path artifacts
        if: always()
        uses: actions/upload-artifact@0b2256b8c012f0828dc542b3febcab082c67f72b  # v4.3.4 pinned
        with:
          name: golden-path-artifacts
          path: artifacts/golden_path

      - name: Root contract validation
        run: |
          python scripts/validate_root_contracts.py
          python scripts/lint_casing.py

      - name: Invariant coverage gate
        run: |
          python scripts/validate_invariant_coverage.py --run-id ci-run

      - name: PDL schema validation gate
        run: |
          python scripts/validate_pdl_artifacts.py --pdl-dir pdl --schema-dir schemas --report-dir artifacts/validation --run-id ci-run

      - name: Promotion readiness gate
        run: |
          python scripts/run_promotion_readiness.py --run-id ci-run

      - name: Run tests
        run: |
          pytest -q
          echo "ðŸš€ SSWG-MVM CI Summary"
          echo "â€¢ Version: $SSWG_VERSION"
          echo "â€¢ Python: $(python3 --version)"
          echo "â€¢ Installed packages:"
          pip list
          echo "â€¢ Completed at: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"

  entropy-optimization-checks:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.10]

    steps:
      - uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332
      - name: ðŸ“¦ Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          if [ -f reproducibility/requirements.txt ]; 
            then
              pip install -r reproducibility/requirements.txt
          elif [ -f REQUIREMENTS.txt ]; 
            then
              pip install -r REQUIREMENTS.txt
          if [ -f pyproject.toml ]; 
            then
              pip install -e ".[dev]"
          elif [ -f build/REQUIREMENTS.txt ]; 
            then
              pip install -r build/REQUIREMENTS.txt
          pip install fastapi uvicorn flake8 pytest httpx pytest rich black json

      - name: Entropy + optimization test suite
        run: |
          pytest -q tests/test_optimization_engine.py tests/test_evaluation.py tests/test_evaluation_checkpoints.py
