name: SSWG MVM CI & Validation

on:
  push:
    paths:
      - "sswg.yaml"
      - "mvm.yaml"
      - "execution_policy.yaml"
      - "governance.yaml"
      - "invariants.yaml"
      - "root_contract.yaml"
      - "ai_system_prompt.txt"
      - "data/templates/**"
      - "ai_validation/**"
      - "schemas/**"
      - "generator/**"
      - "ai_graph/**"
      - "ai_visualization/**"
      - "tests/**"
      - ".github/workflows/sswg-mvm-ci.yml"
  pull_request:
    paths:
      - "sswg.yaml"
      - "mvm.yaml"
      - "execution_policy.yaml"
      - "governance.yaml"
      - "invariants.yaml"
      - "root_contract.yaml"
      - "ai_system_prompt.txt"
      - "data/templates/**"
      - "ai_validation/**"
      - "schemas/**"
      - "generator/**"
      - "ai_graph/**"
      - "ai_visualization/**"
      - "tests/**"
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.10]

    steps:
      - uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332
      - name: ðŸ“¦ Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          if [ -f reproducibility/requirements.txt ]; 
            then
              pip install -r reproducibility/requirements.txt
          elif [ -f REQUIREMENTS.txt ]; 
            then
              pip install -r REQUIREMENTS.txt
          if [ -f pyproject.toml ]; 
            then
              pip install -e ".[dev]"
          elif [ -f build/REQUIREMENTS.txt ]; 
            then
              pip install -r build/REQUIREMENTS.txt
          pip install fastapi uvicorn flake8 pytest httpx pytest rich black json

      - name: Schema validation (example workflows)
        run: |
          python -c "from ai_validation.schema_validator import validate_workflow; import json; import sys; wf=json.load(open('data/templates/campfire_workflow.json')); ok, errs=validate_workflow(wf); sys.exit(1 if not ok else 0)"

      - name: PDL validation (example phase set)
        run: |
          python -m generator.pdl_validator pdl/example_full_9_phase.yaml

      - name: Root contract validation
        run: |
          python scripts/validate_root_contracts.py
          python scripts/lint_casing.py

      - name: Run tests
        run: |
          pytest -q          echo "ðŸš€ SSWG-MVM CI Summary"
          echo "â€¢ Version: $SSWG_VERSION"
          echo "â€¢ Python: $(python3 --version)"
          echo "â€¢ Installed packages:"
          pip list
          echo "â€¢ Completed at: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
